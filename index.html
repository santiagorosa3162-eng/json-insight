<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JSON Insight — Data Visualizer & Validator</title>
<style>
/* ============================================================
   CSS VARIABLES & RESET
   ============================================================ */
:root {
  --bg-primary: #0f1117;
  --bg-secondary: #161822;
  --bg-tertiary: #1c1f2e;
  --bg-input: #12141e;
  --bg-hover: #1f2335;
  --border-primary: #262a3a;
  --border-subtle: #1e2232;
  --text-primary: #c9cdd8;
  --text-secondary: #7c819a;
  --text-muted: #505470;
  --accent: #3d8fd6;
  --accent-dim: #2a6aa3;
  --accent-glow: rgba(61, 143, 214, 0.12);
  --success: #3fb68b;
  --success-bg: rgba(63, 182, 139, 0.08);
  --error: #e05565;
  --error-bg: rgba(224, 85, 101, 0.08);
  --type-string: #89b4a8;
  --type-number: #d4a05a;
  --type-boolean: #c08ade;
  --type-null: #7c819a;
  --type-key: #8aaed6;
  --type-bracket: #606580;
  --radius-sm: 4px;
  --radius-md: 6px;
  --radius-lg: 10px;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.25);
  --shadow-md: 0 2px 8px rgba(0,0,0,0.3);
  --shadow-lg: 0 4px 20px rgba(0,0,0,0.4);
  --font-mono: 'SF Mono', 'Cascadia Code', 'Fira Code', 'JetBrains Mono', 'Consolas', monospace;
  --font-sans: 'SF Pro Text', -apple-system, 'Segoe UI', system-ui, sans-serif;
  --transition-fast: 120ms ease;
  --transition-normal: 200ms ease;
}

*, *::before, *::after {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  font-size: 14px;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

body {
  font-family: var(--font-sans);
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  line-height: 1.55;
}

/* ============================================================
   SCROLLBAR
   ============================================================ */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-primary); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

/* ============================================================
   HEADER
   ============================================================ */
.app-header {
  padding: 28px 32px 20px;
  border-bottom: 1px solid var(--border-subtle);
  background: var(--bg-primary);
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-inner {
  max-width: 1360px;
  margin: 0 auto;
}

.app-title {
  font-family: var(--font-mono);
  font-size: 1.15rem;
  font-weight: 600;
  color: var(--text-primary);
  letter-spacing: -0.02em;
  display: flex;
  align-items: center;
  gap: 10px;
}

.app-title .icon {
  width: 20px;
  height: 20px;
  background: var(--accent);
  border-radius: 4px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  color: #fff;
  font-weight: 700;
  flex-shrink: 0;
}

.app-subtitle {
  font-size: 0.855rem;
  color: var(--text-muted);
  margin-top: 4px;
  font-weight: 400;
  letter-spacing: 0.01em;
}

/* ============================================================
   MAIN LAYOUT
   ============================================================ */
.app-main {
  flex: 1;
  max-width: 1360px;
  width: 100%;
  margin: 0 auto;
  padding: 24px 32px 40px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  align-items: start;
}

@media (max-width: 960px) {
  .app-main { grid-template-columns: 1fr; }
  .app-header { padding: 20px 16px 16px; }
  .app-main { padding: 16px; }
}

/* ============================================================
   PANELS
   ============================================================ */
.panel {
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-lg);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
}

.panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border-subtle);
  background: var(--bg-tertiary);
  min-height: 44px;
}

.panel-label {
  font-family: var(--font-mono);
  font-size: 0.78rem;
  font-weight: 500;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.06em;
}

.panel-body {
  padding: 0;
}

/* ============================================================
   TOOLBAR BUTTONS
   ============================================================ */
.toolbar {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.btn {
  font-family: var(--font-mono);
  font-size: 0.75rem;
  font-weight: 500;
  padding: 5px 12px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border-primary);
  background: var(--bg-secondary);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--transition-fast);
  white-space: nowrap;
  user-select: none;
}

.btn:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
  border-color: var(--text-muted);
}

.btn:active {
  transform: scale(0.97);
}

.btn-accent {
  background: var(--accent-dim);
  color: #e0eaf5;
  border-color: var(--accent);
}

.btn-accent:hover {
  background: var(--accent);
  color: #fff;
}

.btn-danger {
  color: var(--error);
}

.btn-danger:hover {
  background: var(--error-bg);
  border-color: var(--error);
}

/* Hidden file input */
.file-input-hidden {
  display: none;
}

/* ============================================================
   TEXTAREA — JSON INPUT
   ============================================================ */
.json-input-wrap {
  position: relative;
}

.json-input {
  width: 100%;
  min-height: 420px;
  max-height: 70vh;
  padding: 16px;
  font-family: var(--font-mono);
  font-size: 0.82rem;
  line-height: 1.65;
  background: var(--bg-input);
  color: var(--text-primary);
  border: none;
  outline: none;
  resize: vertical;
  tab-size: 2;
  white-space: pre;
  overflow-wrap: normal;
  overflow-x: auto;
}

.json-input::placeholder {
  color: var(--text-muted);
}

.json-input:focus {
  background: #13151f;
}

/* Drag & drop overlay */
.drop-overlay {
  display: none;
  position: absolute;
  inset: 0;
  background: rgba(61, 143, 214, 0.06);
  border: 2px dashed var(--accent);
  border-radius: var(--radius-md);
  z-index: 10;
  align-items: center;
  justify-content: center;
  pointer-events: none;
}

.drop-overlay.active {
  display: flex;
}

.drop-overlay span {
  font-family: var(--font-mono);
  font-size: 0.85rem;
  color: var(--accent);
  padding: 8px 16px;
  background: var(--bg-secondary);
  border-radius: var(--radius-sm);
}

/* ============================================================
   STATUS BAR
   ============================================================ */
.status-bar {
  display: none;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  font-family: var(--font-mono);
  font-size: 0.78rem;
  border-top: 1px solid var(--border-subtle);
}

.status-bar.visible { display: flex; }

.status-bar.success {
  background: var(--success-bg);
  color: var(--success);
  border-top-color: rgba(63, 182, 139, 0.15);
}

.status-bar.error {
  background: var(--error-bg);
  color: var(--error);
  border-top-color: rgba(224, 85, 101, 0.15);
}

.status-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  flex-shrink: 0;
}

.status-bar.success .status-dot { background: var(--success); }
.status-bar.error .status-dot { background: var(--error); }

.status-message {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* ============================================================
   OUTPUT PANEL — RIGHT SIDE
   ============================================================ */
.output-panel {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* ============================================================
   STATISTICS PANEL
   ============================================================ */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1px;
  background: var(--border-subtle);
}

@media (max-width: 600px) {
  .stats-grid { grid-template-columns: repeat(3, 1fr); }
}

.stat-cell {
  background: var(--bg-secondary);
  padding: 14px 12px;
  text-align: center;
}

.stat-value {
  font-family: var(--font-mono);
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--text-primary);
  line-height: 1;
}

.stat-label {
  font-size: 0.7rem;
  color: var(--text-muted);
  margin-top: 6px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  font-family: var(--font-mono);
}

.stats-empty {
  padding: 20px 16px;
  text-align: center;
  font-family: var(--font-mono);
  font-size: 0.78rem;
  color: var(--text-muted);
}

/* ============================================================
   TREE VIEW
   ============================================================ */
.tree-container {
  padding: 12px 16px;
  font-family: var(--font-mono);
  font-size: 0.8rem;
  line-height: 1.7;
  max-height: 540px;
  overflow: auto;
  min-height: 120px;
}

.tree-empty {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 120px;
  color: var(--text-muted);
  font-family: var(--font-mono);
  font-size: 0.8rem;
}

/* Tree node structure */
.tree-node {
  position: relative;
}

.tree-line {
  display: flex;
  align-items: baseline;
  padding: 1px 0;
  cursor: default;
  border-radius: 2px;
  padding-left: 4px;
  margin-left: -4px;
}

.tree-line:hover {
  background: rgba(255,255,255,0.02);
}

.tree-toggle {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 16px;
  height: 16px;
  cursor: pointer;
  color: var(--text-muted);
  font-size: 10px;
  flex-shrink: 0;
  border-radius: 2px;
  transition: color var(--transition-fast);
  user-select: none;
  position: relative;
  top: 1px;
  margin-right: 2px;
}

.tree-toggle:hover {
  color: var(--accent);
  background: var(--accent-glow);
}

.tree-toggle-placeholder {
  display: inline-block;
  width: 16px;
  flex-shrink: 0;
  margin-right: 2px;
}

.tree-key {
  color: var(--type-key);
  margin-right: 0;
}

.tree-colon {
  color: var(--text-muted);
  margin-right: 6px;
}

.tree-bracket {
  color: var(--type-bracket);
  font-weight: 500;
}

.tree-value-string { color: var(--type-string); }
.tree-value-number { color: var(--type-number); }
.tree-value-boolean { color: var(--type-boolean); }
.tree-value-null { color: var(--type-null); font-style: italic; }

.tree-count {
  color: var(--text-muted);
  font-size: 0.72rem;
  margin-left: 6px;
  opacity: 0.7;
}

/* Indented children with connecting lines */
.tree-children {
  padding-left: 20px;
  position: relative;
  overflow: hidden;
  transition: max-height 200ms ease, opacity 150ms ease;
}

.tree-children::before {
  content: '';
  position: absolute;
  left: 8px;
  top: 0;
  bottom: 8px;
  width: 1px;
  background: var(--border-primary);
}

.tree-children.collapsed {
  max-height: 0 !important;
  opacity: 0;
  pointer-events: none;
}

.tree-closing-bracket {
  padding: 1px 0;
}

/* ============================================================
   FOOTER
   ============================================================ */
.app-footer {
  padding: 16px 32px;
  text-align: center;
  font-family: var(--font-mono);
  font-size: 0.72rem;
  color: var(--text-muted);
  border-top: 1px solid var(--border-subtle);
  letter-spacing: 0.01em;
  background: var(--bg-primary);
}

/* ============================================================
   UTILITY ANIMATIONS
   ============================================================ */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(4px); }
  to { opacity: 1; transform: translateY(0); }
}

.fade-in {
  animation: fadeIn 200ms ease forwards;
}
</style>
</head>
<body>

<!-- ============================================================
     HEADER
     ============================================================ -->
<header class="app-header">
  <div class="header-inner">
    <div class="app-title">
      <span class="icon">{}</span>
      JSON Insight
    </div>
    <p class="app-subtitle">Visualize and validate structured JSON data.</p>
  </div>
</header>

<!-- ============================================================
     MAIN CONTENT
     ============================================================ -->
<main class="app-main">

  <!-- LEFT: Input Panel -->
  <div class="panel" id="inputPanel">
    <div class="panel-header">
      <span class="panel-label">Input</span>
      <div class="toolbar">
        <button class="btn" id="btnUpload" title="Upload .json file">Upload</button>
        <button class="btn btn-accent" id="btnValidate" title="Validate JSON syntax">Validate</button>
        <button class="btn" id="btnFormat" title="Beautify JSON">Format</button>
        <button class="btn btn-danger" id="btnClear" title="Clear input">Clear</button>
      </div>
      <input type="file" accept=".json,application/json" class="file-input-hidden" id="fileInput">
    </div>
    <div class="panel-body json-input-wrap" id="inputWrap">
      <textarea
        class="json-input"
        id="jsonInput"
        placeholder='Paste JSON here, or drag & drop a .json file…'
        spellcheck="false"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="off"
      ></textarea>
      <div class="drop-overlay" id="dropOverlay">
        <span>Drop .json file</span>
      </div>
    </div>
    <div class="status-bar" id="statusBar">
      <span class="status-dot"></span>
      <span class="status-message" id="statusMessage"></span>
    </div>
  </div>

  <!-- RIGHT: Output Panel -->
  <div class="output-panel">

    <!-- Statistics -->
    <div class="panel" id="statsPanel">
      <div class="panel-header">
        <span class="panel-label">Statistics</span>
      </div>
      <div class="panel-body" id="statsBody">
        <div class="stats-empty">Parse valid JSON to view statistics.</div>
      </div>
    </div>

    <!-- Tree View -->
    <div class="panel" id="treePanel">
      <div class="panel-header">
        <span class="panel-label">Tree View</span>
        <div class="toolbar">
          <button class="btn" id="btnExpandAll">Expand All</button>
          <button class="btn" id="btnCollapseAll">Collapse All</button>
        </div>
      </div>
      <div class="panel-body">
        <div class="tree-container" id="treeContainer">
          <div class="tree-empty">Parse valid JSON to view tree.</div>
        </div>
      </div>
    </div>

  </div>
</main>

<!-- ============================================================
     FOOTER
     ============================================================ -->
<footer class="app-footer">
  JSON Insight — Data Visualizer &amp; Validator · Created by Santiago Rosa
</footer>

<!-- ============================================================
     APPLICATION LOGIC
     ============================================================ -->
<script>
(function () {
  'use strict';

  /* ===========================================================
     DOM REFERENCES
     =========================================================== */
  const DOM = {
    jsonInput:    document.getElementById('jsonInput'),
    inputWrap:    document.getElementById('inputWrap'),
    dropOverlay:  document.getElementById('dropOverlay'),
    fileInput:    document.getElementById('fileInput'),
    statusBar:    document.getElementById('statusBar'),
    statusMessage:document.getElementById('statusMessage'),
    statsBody:    document.getElementById('statsBody'),
    treeContainer:document.getElementById('treeContainer'),
    btnUpload:    document.getElementById('btnUpload'),
    btnValidate:  document.getElementById('btnValidate'),
    btnFormat:    document.getElementById('btnFormat'),
    btnClear:     document.getElementById('btnClear'),
    btnExpandAll: document.getElementById('btnExpandAll'),
    btnCollapseAll:document.getElementById('btnCollapseAll'),
  };

  /* ===========================================================
     STATE
     Holds the last successfully parsed JSON data to avoid
     redundant re-parsing across features.
     =========================================================== */
  let currentParsed = null;

  /* ===========================================================
     PARSING MODULE
     Centralized JSON parsing with detailed error extraction.
     =========================================================== */
  const Parser = {
    /**
     * Attempt to parse a JSON string.
     * Returns { success, data, error, position }.
     * - `position` is the approximate character index of the error.
     */
    parse(raw) {
      if (!raw || !raw.trim()) {
        return { success: false, data: null, error: 'Input is empty.', position: null };
      }
      try {
        const data = JSON.parse(raw);
        return { success: true, data, error: null, position: null };
      } catch (err) {
        const position = this._extractPosition(err.message);
        return {
          success: false,
          data: null,
          error: err.message,
          position,
        };
      }
    },

    /**
     * Extract approximate character position from native SyntaxError messages.
     * Browsers report position differently:
     *   Chrome: "... at position 42"
     *   Firefox: "... at line 3 column 8"
     */
    _extractPosition(msg) {
      // Chrome / V8 style
      const posMatch = msg.match(/position\s+(\d+)/i);
      if (posMatch) return parseInt(posMatch[1], 10);

      // Firefox style — convert line:col to approximate offset
      const lineColMatch = msg.match(/line\s+(\d+)\s+column\s+(\d+)/i);
      if (lineColMatch) {
        return { line: parseInt(lineColMatch[1], 10), column: parseInt(lineColMatch[2], 10) };
      }
      return null;
    },

    /**
     * Beautify a raw JSON string with 2-space indentation.
     * Returns the formatted string or null if invalid.
     */
    beautify(raw) {
      const result = this.parse(raw);
      if (!result.success) return null;
      return JSON.stringify(result.data, null, 2);
    }
  };

  /* ===========================================================
     STATISTICS MODULE
     Recursively computes structural statistics from parsed JSON.
     =========================================================== */
  const Statistics = {
    /**
     * Compute stats for a parsed JSON value.
     * Returns: { keys, objects, arrays, maxDepth, primitives }
     */
    compute(data) {
      const stats = { keys: 0, objects: 0, arrays: 0, maxDepth: 0, primitives: 0 };
      this._walk(data, 1, stats);
      return stats;
    },

    /**
     * Recursive walker.
     * - depth tracks nesting level for maxDepth calculation.
     * - stats is mutated in place for efficiency.
     */
    _walk(value, depth, stats) {
      if (depth > stats.maxDepth) {
        stats.maxDepth = depth;
      }

      if (value === null || typeof value !== 'object') {
        // Primitive value: string, number, boolean, null
        stats.primitives++;
        return;
      }

      if (Array.isArray(value)) {
        stats.arrays++;
        for (let i = 0; i < value.length; i++) {
          this._walk(value[i], depth + 1, stats);
        }
      } else {
        // Object
        stats.objects++;
        const keys = Object.keys(value);
        stats.keys += keys.length;
        for (let i = 0; i < keys.length; i++) {
          this._walk(value[keys[i]], depth + 1, stats);
        }
      }
    }
  };

  /* ===========================================================
     TREE RENDERER MODULE
     Builds an interactive, recursive tree view of parsed JSON.
     =========================================================== */
  const TreeRenderer = {
    /**
     * Maximum initial depth to auto-expand.
     * Deeper nodes start collapsed for performance.
     */
    AUTO_EXPAND_DEPTH: 3,

    /**
     * Render the complete tree and insert into the container.
     */
    render(data) {
      DOM.treeContainer.innerHTML = '';
      const fragment = document.createDocumentFragment();
      const rootNode = this._createNode(null, data, 0, true);
      fragment.appendChild(rootNode);
      DOM.treeContainer.appendChild(fragment);
      DOM.treeContainer.classList.add('fade-in');
    },

    /**
     * Create a tree node element for a given key/value pair.
     * @param {string|null} key   — The property key (null for root or array items shown by index)
     * @param {*}           value — The JSON value
     * @param {number}      depth — Current nesting depth (for auto expand/collapse)
     * @param {boolean}     isLast — Whether this is the last sibling (for comma placement)
     * @returns {HTMLElement}
     */
    _createNode(key, value, depth, isLast) {
      const node = document.createElement('div');
      node.className = 'tree-node';

      const isExpandable = value !== null && typeof value === 'object';

      if (isExpandable) {
        // ---- Expandable: Object or Array ----
        const isArray = Array.isArray(value);
        const entries = isArray ? value : Object.entries(value);
        const count = isArray ? value.length : Object.keys(value).length;
        const openBracket = isArray ? '[' : '{';
        const closeBracket = isArray ? ']' : '}';
        const autoExpand = depth < this.AUTO_EXPAND_DEPTH;

        // Header line: toggle + key + open bracket + count
        const headerLine = document.createElement('div');
        headerLine.className = 'tree-line';

        const toggle = document.createElement('span');
        toggle.className = 'tree-toggle';
        toggle.textContent = autoExpand ? '▼' : '▶';
        toggle.setAttribute('aria-label', autoExpand ? 'Collapse' : 'Expand');
        headerLine.appendChild(toggle);

        if (key !== null) {
          const keySpan = document.createElement('span');
          keySpan.className = 'tree-key';
          keySpan.textContent = '"' + this._escapeHtml(String(key)) + '"';
          headerLine.appendChild(keySpan);

          const colon = document.createElement('span');
          colon.className = 'tree-colon';
          colon.textContent = ': ';
          headerLine.appendChild(colon);
        }

        const bracketOpen = document.createElement('span');
        bracketOpen.className = 'tree-bracket';
        bracketOpen.textContent = openBracket;
        headerLine.appendChild(bracketOpen);

        // Item count hint (shown when collapsed)
        const countSpan = document.createElement('span');
        countSpan.className = 'tree-count';
        countSpan.textContent = count + (count === 1 ? ' item' : ' items');
        if (autoExpand) countSpan.style.display = 'none';
        headerLine.appendChild(countSpan);

        node.appendChild(headerLine);

        // Children container
        const childrenDiv = document.createElement('div');
        childrenDiv.className = 'tree-children' + (autoExpand ? '' : ' collapsed');
        // Set explicit max-height for transition when expanded
        // We'll set it after appending children
        if (autoExpand) {
          childrenDiv.style.maxHeight = 'none';
          childrenDiv.style.opacity = '1';
        }

        if (isArray) {
          for (let i = 0; i < entries.length; i++) {
            childrenDiv.appendChild(this._createNode(i, entries[i], depth + 1, i === entries.length - 1));
          }
        } else {
          for (let i = 0; i < entries.length; i++) {
            const [k, v] = entries[i];
            childrenDiv.appendChild(this._createNode(k, v, depth + 1, i === entries.length - 1));
          }
        }

        node.appendChild(childrenDiv);

        // Closing bracket
        const closingLine = document.createElement('div');
        closingLine.className = 'tree-closing-bracket';
        const bracketClose = document.createElement('span');
        bracketClose.className = 'tree-bracket';
        bracketClose.textContent = closeBracket + (isLast ? '' : ',');
        closingLine.appendChild(bracketClose);

        if (autoExpand) {
          closingLine.style.display = '';
        } else {
          closingLine.style.display = 'none';
        }

        node.appendChild(closingLine);

        // Toggle click handler
        toggle.addEventListener('click', function () {
          const isCollapsed = childrenDiv.classList.contains('collapsed');
          if (isCollapsed) {
            // Expand
            childrenDiv.classList.remove('collapsed');
            childrenDiv.style.maxHeight = 'none';
            childrenDiv.style.opacity = '1';
            toggle.textContent = '▼';
            toggle.setAttribute('aria-label', 'Collapse');
            countSpan.style.display = 'none';
            closingLine.style.display = '';
          } else {
            // Collapse
            childrenDiv.classList.add('collapsed');
            childrenDiv.style.maxHeight = '0';
            childrenDiv.style.opacity = '0';
            toggle.textContent = '▶';
            toggle.setAttribute('aria-label', 'Expand');
            countSpan.style.display = '';
            closingLine.style.display = 'none';
          }
        });

      } else {
        // ---- Primitive value: string, number, boolean, null ----
        const line = document.createElement('div');
        line.className = 'tree-line';

        // Placeholder for alignment with toggle icons
        const placeholder = document.createElement('span');
        placeholder.className = 'tree-toggle-placeholder';
        line.appendChild(placeholder);

        if (key !== null) {
          const keySpan = document.createElement('span');
          keySpan.className = 'tree-key';
          keySpan.textContent = '"' + this._escapeHtml(String(key)) + '"';
          line.appendChild(keySpan);

          const colon = document.createElement('span');
          colon.className = 'tree-colon';
          colon.textContent = ': ';
          line.appendChild(colon);
        }

        const valueSpan = document.createElement('span');
        const typeClass = this._getTypeClass(value);
        valueSpan.className = typeClass;
        valueSpan.textContent = this._formatPrimitive(value) + (isLast ? '' : ',');
        line.appendChild(valueSpan);

        node.appendChild(line);
      }

      return node;
    },

    /**
     * Return CSS class name for a primitive value type.
     */
    _getTypeClass(value) {
      if (value === null) return 'tree-value-null';
      switch (typeof value) {
        case 'string': return 'tree-value-string';
        case 'number': return 'tree-value-number';
        case 'boolean': return 'tree-value-boolean';
        default: return 'tree-value-string';
      }
    },

    /**
     * Format a primitive value for display.
     * Strings are wrapped in quotes; others displayed as-is.
     */
    _formatPrimitive(value) {
      if (value === null) return 'null';
      if (typeof value === 'string') {
        // Truncate extremely long strings in tree view
        const display = value.length > 120 ? value.slice(0, 120) + '…' : value;
        return '"' + this._escapeHtml(display) + '"';
      }
      return String(value);
    },

    /**
     * Escape HTML special characters to prevent XSS in tree rendering.
     */
    _escapeHtml(str) {
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    },

    /**
     * Expand all nodes in the tree.
     */
    expandAll() {
      const children = DOM.treeContainer.querySelectorAll('.tree-children.collapsed');
      children.forEach(function (el) {
        el.classList.remove('collapsed');
        el.style.maxHeight = 'none';
        el.style.opacity = '1';
      });
      DOM.treeContainer.querySelectorAll('.tree-toggle').forEach(function (t) {
        t.textContent = '▼';
      });
      DOM.treeContainer.querySelectorAll('.tree-count').forEach(function (c) {
        c.style.display = 'none';
      });
      DOM.treeContainer.querySelectorAll('.tree-closing-bracket').forEach(function (b) {
        b.style.display = '';
      });
    },

    /**
     * Collapse all nodes in the tree (except root).
     */
    collapseAll() {
      const allChildren = DOM.treeContainer.querySelectorAll('.tree-children');
      allChildren.forEach(function (el, index) {
        // Keep root expanded
        if (index === 0) return;
        el.classList.add('collapsed');
        el.style.maxHeight = '0';
        el.style.opacity = '0';
      });
      const toggles = DOM.treeContainer.querySelectorAll('.tree-toggle');
      toggles.forEach(function (t, index) {
        if (index === 0) return;
        t.textContent = '▶';
      });
      const counts = DOM.treeContainer.querySelectorAll('.tree-count');
      counts.forEach(function (c, index) {
        if (index === 0) return;
        c.style.display = '';
      });
      const closings = DOM.treeContainer.querySelectorAll('.tree-closing-bracket');
      closings.forEach(function (b, index) {
        if (index === 0) return;
        b.style.display = 'none';
      });
    }
  };

  /* ===========================================================
     UI MODULE
     Handles status messages, stats rendering, and state resets.
     =========================================================== */
  const UI = {
    /**
     * Show a status message below the input.
     * @param {'success'|'error'} type
     * @param {string} message
     */
    showStatus(type, message) {
      DOM.statusBar.className = 'status-bar visible ' + type;
      DOM.statusMessage.textContent = message;
    },

    /** Hide the status bar. */
    hideStatus() {
      DOM.statusBar.className = 'status-bar';
    },

    /**
     * Render statistics into the stats panel.
     * @param {{ keys, objects, arrays, maxDepth, primitives }} stats
     */
    renderStats(stats) {
      DOM.statsBody.innerHTML =
        '<div class="stats-grid">' +
          '<div class="stat-cell"><div class="stat-value">' + stats.keys + '</div><div class="stat-label">Keys</div></div>' +
          '<div class="stat-cell"><div class="stat-value">' + stats.objects + '</div><div class="stat-label">Objects</div></div>' +
          '<div class="stat-cell"><div class="stat-value">' + stats.arrays + '</div><div class="stat-label">Arrays</div></div>' +
          '<div class="stat-cell"><div class="stat-value">' + stats.maxDepth + '</div><div class="stat-label">Max Depth</div></div>' +
          '<div class="stat-cell"><div class="stat-value">' + stats.primitives + '</div><div class="stat-label">Primitives</div></div>' +
        '</div>';
    },

    /** Reset statistics to empty state. */
    clearStats() {
      DOM.statsBody.innerHTML = '<div class="stats-empty">Parse valid JSON to view statistics.</div>';
    },

    /** Reset tree to empty state. */
    clearTree() {
      DOM.treeContainer.innerHTML = '<div class="tree-empty">Parse valid JSON to view tree.</div>';
    },

    /**
     * Build the error detail string, including position info if available.
     */
    formatError(error, position) {
      let msg = 'Invalid JSON — ' + error;
      if (position !== null) {
        if (typeof position === 'number') {
          msg += ' (at character ' + position + ')';
        } else if (position.line) {
          msg += ' (line ' + position.line + ', column ' + position.column + ')';
        }
      }
      return msg;
    }
  };

  /* ===========================================================
     CORE ACTIONS
     High-level operations that compose Parser, Statistics,
     TreeRenderer, and UI modules.
     =========================================================== */

  /**
   * Full validate + parse + render pipeline.
   * Called by Validate button and after file upload.
   */
  function processInput() {
    const raw = DOM.jsonInput.value;
    const result = Parser.parse(raw);

    if (!result.success) {
      currentParsed = null;
      UI.showStatus('error', UI.formatError(result.error, result.position));
      UI.clearStats();
      UI.clearTree();
      return;
    }

    currentParsed = result.data;

    // Success status
    UI.showStatus('success', 'Valid JSON — parsed successfully.');

    // Compute and render statistics
    const stats = Statistics.compute(result.data);
    UI.renderStats(stats);

    // Render tree view
    TreeRenderer.render(result.data);
  }

  /**
   * Format / beautify the input textarea contents.
   */
  function formatInput() {
    const raw = DOM.jsonInput.value;
    if (!raw.trim()) {
      UI.showStatus('error', 'Input is empty.');
      return;
    }
    const beautified = Parser.beautify(raw);
    if (beautified === null) {
      // Parse failed — run full process to show error
      processInput();
      return;
    }
    DOM.jsonInput.value = beautified;
    // Also run full pipeline so tree + stats update
    processInput();
  }

  /**
   * Clear everything — input, status, stats, tree.
   */
  function clearAll() {
    DOM.jsonInput.value = '';
    currentParsed = null;
    UI.hideStatus();
    UI.clearStats();
    UI.clearTree();
  }

  /**
   * Handle a dropped or uploaded file.
   * Reads the file as text and populates the input textarea.
   */
  function handleFile(file) {
    if (!file) return;

    // Basic validation: check MIME type or extension
    const isJson = file.type === 'application/json' ||
                   file.name.toLowerCase().endsWith('.json');
    if (!isJson) {
      UI.showStatus('error', 'Please upload a valid .json file.');
      return;
    }

    // Safety: reject files larger than 10MB to avoid browser hang
    if (file.size > 10 * 1024 * 1024) {
      UI.showStatus('error', 'File is too large (max 10 MB).');
      return;
    }

    const reader = new FileReader();
    reader.onload = function (e) {
      DOM.jsonInput.value = e.target.result;
      processInput();
    };
    reader.onerror = function () {
      UI.showStatus('error', 'Failed to read file.');
    };
    reader.readAsText(file);
  }

  /* ===========================================================
     EVENT BINDINGS
     =========================================================== */

  // Toolbar buttons
  DOM.btnValidate.addEventListener('click', processInput);
  DOM.btnFormat.addEventListener('click', formatInput);
  DOM.btnClear.addEventListener('click', clearAll);
  DOM.btnExpandAll.addEventListener('click', function () { TreeRenderer.expandAll(); });
  DOM.btnCollapseAll.addEventListener('click', function () { TreeRenderer.collapseAll(); });

  // File upload via button
  DOM.btnUpload.addEventListener('click', function () {
    DOM.fileInput.click();
  });
  DOM.fileInput.addEventListener('change', function () {
    if (this.files && this.files[0]) {
      handleFile(this.files[0]);
      // Reset so the same file can be re-uploaded
      this.value = '';
    }
  });

  // Drag & drop support
  let dragCounter = 0;

  DOM.inputWrap.addEventListener('dragenter', function (e) {
    e.preventDefault();
    dragCounter++;
    DOM.dropOverlay.classList.add('active');
  });

  DOM.inputWrap.addEventListener('dragleave', function (e) {
    e.preventDefault();
    dragCounter--;
    if (dragCounter <= 0) {
      dragCounter = 0;
      DOM.dropOverlay.classList.remove('active');
    }
  });

  DOM.inputWrap.addEventListener('dragover', function (e) {
    e.preventDefault();
  });

  DOM.inputWrap.addEventListener('drop', function (e) {
    e.preventDefault();
    dragCounter = 0;
    DOM.dropOverlay.classList.remove('active');

    if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]) {
      handleFile(e.dataTransfer.files[0]);
    }
  });

  // Keyboard shortcut: Ctrl/Cmd + Enter to validate
  DOM.jsonInput.addEventListener('keydown', function (e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      e.preventDefault();
      processInput();
    }
  });

})();
</script>

</body>
</html>
